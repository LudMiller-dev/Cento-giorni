<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Racha 100 días — Odómetro Interactivo</title>
  <style>
    :root{ --bg:#0b0f12; --muted:#a1a1a1; }
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:#fff;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif;
      overflow:hidden; /* para que nada haga scroll */
      display:grid; place-items:center;
    }

    /* Canvas partículas pantalla completa detrás del contenido */
    #fx{
      position:fixed; inset:0; width:100vw; height:100vh;
      pointer-events:none; z-index:0;
    }

    .wrap{
      position:relative; z-index:1;
      width:100%; max-width:780px;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      text-align:center; padding:16px; gap:10px;
    }

    .label{ font-size:12px; color:var(--muted); letter-spacing:.18em; text-transform:uppercase }

    .count{
      display:flex; justify-content:center; align-items:center; gap:10px;
      font-size:clamp(48px, 10vw, 96px); font-weight:900; line-height:1;
      user-select:none; margin-inline:auto; text-align:center;
    }
    .digit-col{
      height:1em; overflow:hidden; min-width:.6em;
      filter:drop-shadow(0 2px 10px rgba(0,0,0,.25));
      visibility:visible;
    }
    .digit-inner{
      display:flex; flex-direction:column;
      will-change:transform;
      transition: transform .46s cubic-bezier(.25,.8,.4,1);
    }
    /* Paleta Duolingo en dígitos */
    .digit-inner span{
      height:1em; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg,#fff,#ffe066 40%,#ff9e2c 70%,#ff7b00 100%);
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }

    /* Encendido final (fuego natural) */
    .count.final .digit-inner span{
      background:linear-gradient(180deg,#fff7d1,#ffd166 40%,#ff8c33 75%,#e64500 100%);
      -webkit-background-clip:text; background-clip:text; color:transparent;
      text-shadow:0 0 14px rgba(255,180,80,.9),0 0 30px rgba(255,110,0,.6);
    }
    .count.final{ animation: finaleGlow 1.1s ease-out forwards; }
    @keyframes finaleGlow{
      0%{ text-shadow:0 0 0 transparent }
      50%{ text-shadow:0 0 25px rgba(255,230,102,.85),0 0 45px rgba(255,158,44,.65),0 0 70px rgba(255,123,0,.5) }
      100%{ text-shadow:0 0 18px rgba(255,230,102,.65),0 0 34px rgba(255,158,44,.55),0 0 60px rgba(255,123,0,.45) }
    }

    .suffix{ font-size:18px; color:var(--muted) }
    .message{
      font-size:clamp(22px, 4.5vw, 32px); font-weight:800;
      background:linear-gradient(90deg,#ffe066,#ff9e2c,#ff7b00);
      -webkit-background-clip:text; color:transparent;
      opacity:0; transform:translateY(10px); transition:.8s;
    }
    .message.show{ opacity:1; transform:none }
  </style>
</head>
<body>
  <!-- Canvas full-screen para chispas y llamas -->
  <canvas id="fx"></canvas>

  <div class="wrap">
    <div class="label">Racha</div>

    <div class="count" id="count" title="Toca para sumar 10">
      <!-- centenas / decenas / unidades -->
      <div class="digit-col"><div class="digit-inner"></div></div>
      <div class="digit-col"><div class="digit-inner"></div></div>
      <div class="digit-col"><div class="digit-inner"></div></div>
    </div>

    <div class="suffix">días</div>
    <div class="message" id="message">¡Felices 100 días, amor! ✨</div>
  </div>

  <script>
    const TARGET = 100;
    let current = 0;
    let running = false;

    const countEl = document.getElementById('count');
    const msg = document.getElementById('message');

    const cols = [...countEl.querySelectorAll('.digit-col')];
    const inners = cols.map(c => c.querySelector('.digit-inner'));
    const state = [0,0,0]; // [centenas, decenas, unidades]
    let lineH = 0;

    // ====== Odómetro ======
    function buildDigits(){
      inners.forEach(inner => {
        inner.innerHTML = '';
        for(let i=0;i<=10;i++){
          const sp = document.createElement('span');
          sp.textContent = i % 10;
          inner.appendChild(sp);
        }
      });
      requestAnimationFrame(() => {
        lineH = Math.round(inners[0].children[0].getBoundingClientRect().height);
        setNumber(0, true);
        cols[0].style.visibility = 'hidden'; // centenas oculta en 0
      });
    }

    const durations = [560, 500, 460]; // ms columnas: C, D, U

    function moveCol(i, targetDigit){
      const inner = inners[i];
      const col = cols[i];
      inner.style.transitionProperty = 'transform';
      inner.style.transitionDuration = durations[i] + 'ms';

      const currentDigit = state[i];
      if(i === 0){ col.style.visibility = targetDigit === 0 ? 'hidden' : 'visible'; }

      let wrap = false;
      let visualTarget = targetDigit;

      if(targetDigit < currentDigit){ // wrap 9->0
        visualTarget = targetDigit + 10;
        wrap = true;
      }

      inner.style.transform = `translateY(${-visualTarget * lineH}px)`;

      if(wrap){
        const handler = () => {
          inner.removeEventListener('transitionend', handler);
          const prev = inner.style.transition;
          inner.style.transition = 'none';
          inner.style.transform = `translateY(${-targetDigit * lineH}px)`;
          void inner.offsetHeight;
          inner.style.transition = prev;
        };
        inner.addEventListener('transitionend', handler, { once:true });
      }

      state[i] = targetDigit;
    }

    function setNumber(n, instant = false){
      const s = String(n).padStart(3,'0');
      const digits = [ +s[0], +s[1], +s[2] ];
      for(let i=0;i<3;i++){
        if(instant){
          const inner = inners[i];
          inner.style.transition = 'none';
          inner.style.transform = `translateY(${-digits[i]*lineH}px)`;
          state[i] = digits[i];
          requestAnimationFrame(()=>{ inner.style.transition = ''; });
        } else if(digits[i] !== state[i]){
          moveCol(i, digits[i]);
        }
      }
    }

    // Hace que la UNIDAD gire una vuelta completa aunque su valor final sea 0
    function spinUnitsOnce(){
      const i = 2; // unidades
      const inner = inners[i];
      const currentDigit = state[i];
      inner.style.transitionDuration = durations[i] + 'ms';
      inner.style.transform = `translateY(${- (currentDigit + 10) * lineH}px)`;
      return new Promise(resolve => {
        const handler = () => {
          inner.removeEventListener('transitionend', handler);
          const prev = inner.style.transition;
          inner.style.transition = 'none';
          inner.style.transform = `translateY(${- currentDigit * lineH}px)`;
          void inner.offsetHeight;
          inner.style.transition = prev;
          resolve();
        };
        inner.addEventListener('transitionend', handler, { once:true });
      });
    }

    function digitsOf(n){
      const s = String(n).padStart(3,'0');
      return [ +s[0], +s[1], +s[2] ];
    }

    // ====== Partículas (chispas y llamas) pantalla completa ======
    const fx = document.getElementById('fx');
    const ctx = fx.getContext('2d', { alpha:true });
    let W = 0, H = 0, particles = [];
    let emitSparks = true;
    let sideRight = true; // alterna derecha/izquierda
    let flameCurtain = false; // llamas subiendo

    function resizeFX(){
      const w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
      const h = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);
      W = fx.width = Math.floor(w * devicePixelRatio);
      H = fx.height = Math.floor(h * devicePixelRatio);
      fx.style.width = w + 'px';
      fx.style.height = h + 'px';
      ctx.setTransform(devicePixelRatio, 0, 0, devicePixelRatio, 0, 0);
    }
    window.addEventListener('resize', resizeFX, { passive:true });
    resizeFX();

    function countCenter(){
      const rect = countEl.getBoundingClientRect();
      const cx = rect.left + rect.width/2;
      const cy = rect.top + rect.height*0.45;
      const half = rect.width/2;
      return { cx, cy, half };
    }

    // CHISPAS: 'right', 'left' o 'both'
    function emitBurst(side='right', n=140){
      if(!emitSparks) return;
      const {cx, cy, half} = countCenter();
      const originRight = { x: cx + half*0.35, y: cy };
      const originLeft  = { x: cx - half*0.35, y: cy };

      for(let i=0;i<n;i++){
        const useLeft = (side==='left') ? true : (side==='right' ? false : (i%2===0));
        const o = useLeft ? originLeft : originRight;
        const speed = 1.6 + Math.random()*2.8;
        const spread = 0.6 + Math.random()*0.6;

        const baseAng = -Math.PI/2;
        const lateral = (useLeft ? -1 : 1) * (0.28 + Math.random()*0.55);
        const ang = baseAng + lateral * spread;

        const vx = Math.cos(ang) * speed;
        const vy = Math.sin(ang) * speed;

        particles.push({
          kind:'spark',
          x:o.x, y:o.y, vx, vy,
          g: 0.05 + Math.random()*0.06,
          drag: 0.991 + Math.random()*0.006,
          life: 640 + Math.random()*420,
          r: 2.4 + Math.random()*3.2,
          hue: (Math.random()<.35) ? 'white' : (Math.random()<.75 ? 'amber' : 'orange'),
          alpha: 1.0,
          prevX:o.x, prevY:o.y,
        });
      }
    }

    // LLAMAS: cortina desde la parte baja de la pantalla que sube y cruza arriba
    function startFlameCurtain(durationMs = 2200){
      flameCurtain = true;
      const start = performance.now();

      function emitFlames(now){
        if(!flameCurtain) return;
        const t = now - start;
        // Emisión intensa los primeros 1.5s, luego cae
        const k = Math.max(0, 1 - Math.max(0, t-1500)/700);
        const baseCount = 24 + Math.floor(28 * k); // 24..52 por frame aprox

        for(let i=0;i<baseCount;i++){
          const x = Math.random() * (W/devicePixelRatio);
          const y = (H/devicePixelRatio) + 10; // un poco bajo
          const up = 2.0 + Math.random()*3.2;
          const side = (Math.random()-0.5) * 0.9; // leve serpenteo lateral
          particles.push({
            kind:'flame',
            x, y, vx:side, vy:-up,
            g: -0.004,           // leve empuje hacia arriba (negativa)
            drag: 0.994,         // arrastre suave
            life: 1200 + Math.random()*900,
            r: 6 + Math.random()*16,
            t0: now + Math.random()*300, // desfase para zigzag
            alpha: 1.0
          });
        }
        if(t < durationMs) requestAnimationFrame(emitFlames);
        else flameCurtain = false; // terminada la emisión (las que quedan siguen subiendo hasta morir)
      }
      requestAnimationFrame(emitFlames);
    }

    function igniteBurst(){
      // ráfaga doble simultánea (ambos lados)
      const {cx, cy, half} = countCenter();
      const originRight = { x: cx + half*0.35, y: cy };
      const originLeft  = { x: cx - half*0.35, y: cy };

      const total = 380;
      for(let i=0;i<total;i++){
        const useLeft = (i % 2 === 0);
        const o = useLeft ? originLeft : originRight;
        const speed = 2.0 + Math.random()*3.6;
        const spread = 0.65 + Math.random()*0.7;
        const baseAng = -Math.PI/2;
        const lateral = (useLeft ? -1 : 1) * (0.3 + Math.random()*0.6);
        const ang = baseAng + lateral * spread;
        const vx = Math.cos(ang) * speed;
        const vy = Math.sin(ang) * speed;

        particles.push({
          kind:'spark',
          x:o.x, y:o.y, vx, vy,
          g: 0.044 + Math.random()*0.055,
          drag: 0.99 + Math.random()*0.006,
          life: 800 + Math.random()*520,
          r: 2.6 + Math.random()*3.2,
          hue: (Math.random()<.35) ? 'white' : (Math.random()<.75 ? 'amber' : 'orange'),
          alpha: 1.0,
          prevX:o.x, prevY:o.y,
        });
      }

      // y disparamos la cortina de llamas ascendentes
      startFlameCurtain(2600);
    }

    function sparkColor(hue, alpha){
      if(hue==='white') return `rgba(255,255,255,${alpha})`;
      if(hue==='amber') return `rgba(255,209,102,${alpha})`;
      return `rgba(255,142,51,${alpha})`; // orange
    }

    // Render general
    function stepFX(){
      ctx.clearRect(0,0,W,H);
      ctx.globalCompositeOperation = 'lighter'; // blend aditivo

      const now = performance.now();

      for(let i=particles.length-1;i>=0;i--){
        const p = particles[i];

        if(p.kind === 'spark'){
          // física chispas
          p.vy += p.g;
          p.vx *= p.drag;
          p.vy *= p.drag;
          p.prevX = p.x; p.prevY = p.y;
          p.x += p.vx;
          p.y += p.vy;
          p.life -= 16;
          p.alpha = Math.max(0, Math.min(1, p.life/700));

          if(p.life <= 0 || p.y > H+40 || p.x < -80 || p.x > W+80){
            particles.splice(i,1); continue;
          }

          // cola
          ctx.strokeStyle = sparkColor(p.hue, p.alpha*0.6);
          ctx.lineWidth = Math.max(1, p.r*0.7);
          ctx.beginPath();
          ctx.moveTo(p.prevX, p.prevY);
          ctx.lineTo(p.x, p.y);
          ctx.stroke();

          // cabeza
          ctx.fillStyle = sparkColor(p.hue, p.alpha);
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
          ctx.fill();
        }
        else { // 'flame'
          // serpenteo leve (zigzag) para simular convección
          const s = Math.sin((now - p.t0) * 0.006);
          p.vx += s * 0.02;

          p.vy += p.g; // g negativa = empuje arriba
          p.vx *= p.drag; p.vy *= p.drag;
          p.x += p.vx; p.y += p.vy;

          p.life -= 16;
          p.alpha = Math.max(0, Math.min(1, p.life/1300));

          if(p.life <= 0 || p.y < -60){ // si ya salió por arriba
            particles.splice(i,1); continue;
          }

          // discos suaves tipo llama (radial)
          const grd = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, p.r*1.4);
          grd.addColorStop(0, `rgba(255,240,180,${p.alpha*0.95})`);
          grd.addColorStop(0.35, `rgba(255,190,100,${p.alpha*0.75})`);
          grd.addColorStop(0.8, `rgba(255,110,10,${p.alpha*0.45})`);
          grd.addColorStop(1, `rgba(255,110,10,0)`);
          ctx.fillStyle = grd;
          ctx.beginPath();
          ctx.arc(p.x, p.y, p.r*1.4, 0, Math.PI*2);
          ctx.fill();
        }
      }
      requestAnimationFrame(stepFX);
    }
    requestAnimationFrame(stepFX);

    // ====== Interacción: +10 por toque, chispas alternadas ======
    function addTen(){
      if(running || current >= TARGET) return;
      running = true;

      if('vibrate' in navigator){ navigator.vibrate(12); }

      // chispas alternadas por toque (derecha/izquierda)
      emitBurst(sideRight ? 'right' : 'left', 160);
      sideRight = !sideRight;

      const next = Math.min(current + 10, TARGET);
      const [c0,d0,u0] = digitsOf(current);
      const [c1,d1,u1] = digitsOf(next);

      const spinU = spinUnitsOnce(); // unidades siempre ruedan

      if(d1 !== d0) moveCol(1, d1);
      if(c1 !== c0) moveCol(0, c1);

      spinU.then(() => {
        current = next;

        if(current === TARGET){
          emitSparks = false;     // ya prendió: no más encendedor
          igniteBurst();          // ráfaga doble + cortina de llamas
          countEl.classList.add('final');
          msg.classList.add('show');
        }
        running = false;
      });
    }

    // ====== Init ======
    buildDigits();
    countEl.addEventListener('pointerdown', addTen, { passive:true });
  </script>
</body>
</html>
